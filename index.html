<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Move It OKR Master</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { 
            --p: #2563eb; --p-dark: #1d4ed8;
            --bg: #f1f5f9; --txt: #0f172a; 
            --nav-bg: #1e293b;
            --card-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }

        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--txt); margin: 0; line-height: 1.5; }
        
        /* Navbar Mejorada */
        .main-navbar {
            display: flex; justify-content: space-between; align-items: center;
            background-color: var(--nav-bg); padding: 0.75rem 1.5rem; color: white;
            position: sticky; top: 0; z-index: 1000; box-shadow: var(--card-shadow);
        }
        .nav-links { display: flex; gap: 15px; }
        .nav-item { 
            color: #94a3b8; text-decoration: none; font-size: 0.9rem; font-weight: 500;
            padding: 8px 12px; border-radius: 6px; transition: 0.2s;
        }
        .nav-item:hover, .nav-item.active { color: white; background: rgba(255,255,255,0.1); }
        .nav-item.active { border-bottom: 2px solid var(--p); border-radius: 4px 4px 0 0; }

        /* UI Components */
        .container { max-width: 650px; margin: 30px auto; padding: 0 20px; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: var(--card-shadow); margin-bottom: 25px; }
        
        input { 
            width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #e2e8f0; 
            border-radius: 8px; box-sizing: border-box; font-size: 1rem; transition: border 0.2s;
        }
        input:focus { outline: none; border-color: var(--p); ring: 2px var(--p); }
        
        .btn { 
            background: var(--p); color: white; border: none; padding: 14px; 
            border-radius: 8px; cursor: pointer; width: 100%; font-weight: 600; 
            font-size: 1rem; transition: background 0.2s; 
        }
        .btn:hover { background: var(--p-dark); }
        .btn:disabled { background: #cbd5e1; cursor: not-allowed; }

        .okr-item { 
            background: white; border-left: 6px solid var(--p); padding: 20px; 
            margin-bottom: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .hidden { display: none !important; }
        .btn-logout { background: #ef4444; border: none; color: white; padding: 6px 12px; border-radius: 6px; cursor: pointer; }

        @media (max-width: 600px) {
            .main-navbar { flex-direction: column; gap: 15px; text-align: center; }
            .nav-links { flex-wrap: wrap; justify-content: center; }
        }
    </style>
</head>
<body>

<nav class="main-navbar">
    <div class="nav-brand"><strong>ðŸš€ Move It</strong></div>
    <div class="nav-links">
        <a href="index.html" class="nav-item active">OKRs</a>
        <a href="tools/checklist/index.html" class="nav-item">Checklist</a>
        <a href="tools/not-to-do/index.html" class="nav-item">Not to Do</a>
        <a href="tools/weekly-list/index.html" class="nav-item">Weekly List</a>
    </div>
    <div id="nav-user" class="hidden">
        <button onclick="logout()" class="btn-logout">Salir</button>
    </div>
</nav>

<div class="container">
    <section id="auth-section" class="card">
        <h2 id="auth-title" style="margin-top:0">Iniciar SesiÃ³n</h2>
        <input type="email" id="email" placeholder="tu@email.com">
        <input type="password" id="password" placeholder="Tu contraseÃ±a secreta">
        <button id="btn-auth" class="btn" onclick="handleAuth()">Entrar</button>
        <p style="text-align:center; font-size: 0.9rem;">
            <a href="javascript:void(0)" onclick="toggleAuth()" id="toggle-text" style="color:var(--p)">Â¿No tienes cuenta? RegÃ­strate</a>
        </p>
        <p style="text-align:center"><a href="javascript:void(0)" onclick="resetPass()" style="font-size:0.8rem; color:#64748b">OlvidÃ© mi contraseÃ±a</a></p>
    </section>

    <section id="app-section" class="hidden">
        <div class="card">
            <h3 style="margin-top:0">ðŸŽ¯ Nuevo Objetivo Anual</h3>
            <input type="text" id="obj-input" placeholder="Ej: Lanzar mi propia App SaaS">
            <input type="text" id="kr1-input" placeholder="KR 1: Conseguir 100 usuarios">
            <input type="text" id="kr2-input" placeholder="KR 2: Facturar $1,000">
            <input type="text" id="kr3-input" placeholder="KR 3: 50% de retenciÃ³n">
            <button class="btn" onclick="saveOKR()">Guardar OKR en la Nube</button>
        </div>

        <h2 style="display:flex; justify-content:space-between; align-items:center;">
            Mis OKRs 
            <small style="font-size:0.5em; background:var(--p); color:white; padding:4px 8px; border-radius:20px" id="okr-count">0</small>
        </h2>
        <div id="list-okr"></div>
    </section>
</div>

<script>
// --- CONFIGURACIÃ“N ---
const SUPABASE_URL = 'https://lddajpesoctuzlhjrpyg.supabase.co';
const SUPABASE_KEY = 'sb_publishable_Ap9YMNrnBaD5Bluj38sWpQ_36j9QWm7';
const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let isRegistering = false;

// --- TRUCO PRO: Selectores cacheables ---
const $ = id => document.getElementById(id);

// --- INTERFAZ ---
window.toggleAuth = () => {
    isRegistering = !isRegistering;
    $('auth-title').innerText = isRegistering ? "Crear Cuenta" : "Iniciar SesiÃ³n";
    $('btn-auth').innerText = isRegistering ? "Registrarse" : "Entrar";
    $('toggle-text').innerText = isRegistering ? "Â¿Ya tienes cuenta? Entra" : "Â¿No tienes cuenta? RegÃ­strate";
};

// --- AUTENTICACIÃ“N ---
window.handleAuth = async () => {
    const email = $('email').value;
    const password = $('password').value;
    const btn = $('btn-auth');
    
    if(!email || !password) return alert("âš ï¸ Datos incompletos");

    btn.disabled = true;
    btn.innerText = "Conectando...";

    try {
        const { error } = isRegistering 
            ? await _supabase.auth.signUp({ email, password })
            : await _supabase.auth.signInWithPassword({ email, password });
        
        if (error) throw error;
        if (isRegistering) alert("ðŸš€ Â¡Casi listo! Confirma tu email.");
        checkUser();
    } catch (err) {
        alert("âŒ Error: " + err.message);
    } finally {
        btn.disabled = false;
        btn.innerText = isRegistering ? "Registrarse" : "Entrar";
    }
};

window.resetPass = async () => {
    const email = $('email').value;
    if (!email) return alert("Escribe tu email primero");
    const { error } = await _supabase.auth.resetPasswordForEmail(email);
    alert(error ? error.message : "ðŸ“§ Email enviado. Revisa tu bandeja.");
};

// --- LÃ“GICA DE OKRS ---
window.saveOKR = async () => {
    const { data: { user } } = await _supabase.auth.getUser();
    const btn = event.target;
    
    const obj = {
        user_id: user.id,
        objetivo: $('obj-input').value.trim(),
        kr1: $('kr1-input').value.trim(),
        kr2: $('kr2-input').value.trim(),
        kr3: $('kr3-input').value.trim()
    };

    if(!obj.objetivo) return alert("Define un objetivo");

    btn.disabled = true;
    const { error } = await _supabase.from('okrs').insert([obj]);

    if (error) {
        alert("Error: " + error.message);
    } else {
        ['obj-input', 'kr1-input', 'kr2-input', 'kr3-input'].forEach(id => $(id).value = "");
        loadOKRs();
    }
    btn.disabled = false;
};

window.loadOKRs = async () => {
    const container = $('list-okr');
    container.innerHTML = '<p style="text-align:center">Cargando...</p>';
    
    const { data, error } = await _supabase.from('okrs')
        .select('*')
        .order('created_at', { ascending: false });
    
    if (error) return container.innerHTML = "Error al cargar.";
    
    $('okr-count').innerText = data.length;
    container.innerHTML = data.length ? "" : "No hay metas registradas.";
    
    // TRUCO PRO: DocumentFragment para mejor rendimiento de renderizado
    data.forEach(item => {
        const div = document.createElement('div');
        div.className = 'okr-item';
        // Usamos innerHTML solo para la estructura, el contenido es texto plano por seguridad
        div.innerHTML = `
            <div style="font-weight:bold; font-size:1.1rem; margin-bottom:10px">ðŸŽ¯ ${escapeHTML(item.objetivo)}</div>
            <div style="font-size:0.9rem; color:#475569">
                <div><strong>KR1:</strong> ${escapeHTML(item.kr1) || '-'}</div>
                <div><strong>KR2:</strong> ${escapeHTML(item.kr2) || '-'}</div>
                <div><strong>KR3:</strong> ${escapeHTML(item.kr3) || '-'}</div>
            </div>
        `;
        container.appendChild(div);
    });
};

// TRUCO PRO: Escapar HTML para evitar XSS
function escapeHTML(str) {
    if (!str) return "";
    return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

// --- CONTROL DE SESIÃ“N ---
window.checkUser = async () => {
    const { data: { session } } = await _supabase.auth.getSession();
    if (session) {
        $('auth-section').classList.add('hidden');
        $('app-section').classList.remove('hidden');
        $('nav-user').classList.remove('hidden');
        loadOKRs();
    }
};

window.logout = async () => {
    await _supabase.auth.signOut();
    location.reload();
};

document.addEventListener('DOMContentLoaded', checkUser);
</script>
</body>
</html>